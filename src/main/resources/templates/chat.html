<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat</title>
  <link rel="stylesheet" href="/css/chat.css"/>
  <!-- SockJS + STOMP (CDN minimal) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link rel="stylesheet" href="/css/chat.css">
</head>
<body>
  <nav><a href="/home">← Back</a></nav>

  <main>
    <ul id="messages"></ul>

    <div id="composer">
      <input id="msg" type="text" placeholder="Scrie un mesaj..." autocomplete="off"/>
      <button id="send" type="button">Trimite</button>
    </div>
  </main>

  <script>
    // extrage chatId din URL: /chat/{chatId}
    const chatId = window.location.pathname.split('/').pop();

    const socket = new SockJS('/websockets');
    const stomp = Stomp.over(socket);
    // opțional: dezactivează logs: stomp.debug = null;

    function appendMessage(m) {
      const li = document.createElement('li');
      li.textContent = `[${new Date(m.createdAt).toLocaleTimeString()}] ${m.userId}: ${m.content}`;
      document.getElementById('messages').appendChild(li);
      li.scrollIntoView({behavior: 'smooth', block: 'end'});
    }

    function connect() {
      stomp.connect({}, () => {
        // subscribe la topicul chatului
        stomp.subscribe(`/topic/chats/${chatId}`, (frame) => {
          const msg = JSON.parse(frame.body);
          appendMessage(msg);
        });

        // (opțional) preia istoric inițial
        fetch(`/api/chats/${chatId}/messages?page=0&size=50`)
          .then(r => r.json())
          .then(page => {
            page.content.forEach(appendMessage);
          })
          .catch(() => {});
      });
    }

    document.getElementById('send').addEventListener('click', () => {
      const input = document.getElementById('msg');
      const text = (input.value || '').trim();
      if (!text) return;
      // trimite către MessageMapping-ul tău: /app/chat/{chatId}/send
      stomp.send(`/app/chat/${chatId}/send`, {}, JSON.stringify({ content: text }));
      input.value = '';
      input.focus();
    });

    document.getElementById('msg').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('send').click();
    });

    connect();
  </script>
</body>
</html>
